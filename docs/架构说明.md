# SOCKS5代理服务器架构说明

## 📋 项目概述

本项目是一个功能完整的SOCKS5代理服务器系统，采用微服务架构设计，包含API管理服务、SOCKS5代理服务和Web管理界面。系统支持用户认证、流量监控、访问控制、日志记录等企业级功能。

## 🏗️ 整体架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                Web管理界面                                  │
│                           (Vue3 + Element Plus)                           │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │  Dashboard  │ │    Users    │ │   Traffic   │ │ ProxyHealth │          │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘          │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              API服务器 (8012)                               │
│                           (Go + Gin + GORM)                                │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │   认证管理   │ │   用户管理   │ │   流量统计   │ │   日志管理   │          │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘          │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │   在线用户   │ │   URL过滤   │ │  IP白名单   │ │   系统状态   │          │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘          │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                             数据库 (MySQL)                                  │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │    用户表    │ │   会话表    │ │   流量日志   │ │   访问日志   │          │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘          │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │   URL过滤   │ │  IP白名单   │ │  带宽限制   │ │   心跳记录   │          │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘          │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            SOCKS5代理服务 (1082)                           │
│                           (Go + 原生Socket)                                │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │   连接管理   │ │   认证验证   │ │   流量转发   │ │   心跳检测   │          │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘          │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 🔧 核心服务组件

### 1. API服务器 (Server Service)

**端口**: 8012  
**技术栈**: Go + Gin + GORM + JWT  
**职责**: 
- 提供RESTful API接口
- 托管Web管理界面
- 处理用户认证和授权
- 管理数据库操作
- 提供系统监控和统计

**主要功能模块**:
```
API服务器
├── 认证管理 (/api/v1/auth/*)
│   ├── 用户登录
│   └── 用户登出
├── 用户管理 (/api/v1/users/*)
│   ├── 用户CRUD
│   ├── 角色管理
│   └── 状态管理
├── 流量管理 (/api/v1/traffic/*)
│   ├── 流量统计
│   ├── 实时流量
│   └── 带宽限制
├── 日志管理 (/api/v1/logs/*)
│   ├── 访问日志
│   ├── 流量日志
│   └── 日志导出
├── 在线用户 (/api/v1/online/*)
│   ├── 在线状态
│   └── 强制断开
├── URL过滤 (/api/v1/filters/*)
│   ├── 过滤规则
│   └── 黑白名单
├── IP白名单 (/api/v1/whitelist/*)
│   ├── IP管理
│   └── 访问控制
├── 系统状态 (/api/v1/system/*)
│   ├── 系统信息
│   └── 性能统计
└── 代理健康 (/api/v1/proxy/*)
    ├── 健康状态
    ├── 心跳记录
    └── 状态监控
```

### 2. SOCKS5代理服务 (Proxy Service)

**端口**: 1082  
**技术栈**: Go + 原生Socket + 自定义协议  
**职责**:
- 处理SOCKS5协议连接
- 执行用户认证
- 转发网络流量
- 记录连接日志
- 维护心跳状态

**SOCKS5协议支持**:
```
SOCKS5协议
├── 认证方法
│   ├── 无认证 (0x00)
│   └── 用户名密码认证 (0x02)
├── 命令类型
│   ├── CONNECT (0x01) - TCP连接
│   ├── BIND (0x02) - TCP绑定
│   └── UDP (0x03) - UDP转发
└── 地址类型
    ├── IPv4 (0x01)
    ├── 域名 (0x03)
    └── IPv6 (0x04)
```

**连接处理流程**:
```
客户端连接 → 认证阶段 → 请求阶段 → 转发阶段 → 数据交换 → 连接关闭
     ↓           ↓         ↓         ↓         ↓         ↓
   TCP握手   用户验证   解析目标   建立连接   双向转发   清理资源
```

### 3. Web管理界面 (Frontend)

**技术栈**: Vue3 + Element Plus + Vue Router + Pinia  
**构建工具**: Vite  
**部署方式**: 静态文件托管在API服务器

**页面结构**:
```
Web管理界面
├── 登录页面 (/login)
├── 主布局 (MainLayout)
│   ├── 仪表板 (/dashboard)
│   ├── 用户管理 (/users)
│   ├── 流量统计 (/traffic)
│   ├── 日志查看 (/logs)
│   ├── 过滤规则 (/filters)
│   └── 代理健康 (/proxy-health)
└── 公共组件
    ├── 导航菜单
    ├── 数据表格
    ├── 表单组件
    └── 状态指示器
```

## 🗄️ 数据模型设计

### 核心数据表

#### 1. 用户管理
- **users**: 用户基本信息、认证凭据、权限角色
- **bandwidth_limits**: 用户带宽限制配置

#### 2. 连接管理
- **proxy_sessions**: 代理会话记录、连接状态、流量统计
- **proxy_heartbeats**: 代理服务器心跳状态、健康监控

#### 3. 流量监控
- **traffic_logs**: 详细流量记录、目标地址、协议类型
- **access_logs**: 访问日志、用户行为、时间戳

#### 4. 访问控制
- **url_filters**: URL过滤规则、黑白名单、正则匹配
- **ip_whitelist**: IP白名单、访问控制、描述信息

## 🔄 数据流和通信

### 1. 用户认证流程
```
用户登录 → API验证 → JWT生成 → 前端存储 → 后续请求携带Token
    ↓         ↓        ↓         ↓         ↓
  表单提交   数据库查询  签名生成  本地存储   中间件验证
```

### 2. 代理连接流程
```
客户端连接 → 认证验证 → 目标解析 → 连接建立 → 数据转发
    ↓         ↓         ↓         ↓         ↓
  SOCKS5握手  用户验证   地址解析   网络连接   双向转发
```

### 3. 心跳监控流程
```
代理服务 → 定期心跳 → 数据库更新 → API查询 → 前端显示
    ↓         ↓         ↓         ↓         ↓
  定时任务   状态上报   记录保存   数据获取   实时更新
```

## 🚀 部署架构

### 开发环境
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端开发      │    │   API服务器     │    │  SOCKS5代理     │
│   npm run dev   │◄──►│   go run        │◄──►│   go run        │
│   (端口3000)    │    │   (端口8012)    │    │   (端口1082)    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 生产环境
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Nginx反向代理  │    │   API服务器     │    │  SOCKS5代理     │
│   (端口80/443)  │◄──►│   (端口8012)    │◄──►│   (端口1082)    │
│   SSL终止       │    │   静态文件托管   │    │   负载均衡      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 🔐 安全特性

### 1. 认证与授权
- **JWT Token**: 无状态认证，支持过期时间
- **角色权限**: 用户、管理员两级权限控制
- **会话管理**: 自动过期、强制登出机制

### 2. 访问控制
- **IP白名单**: 限制允许连接的客户端IP
- **URL过滤**: 基于正则表达式的访问控制
- **带宽限制**: 用户级别的流量控制

### 3. 数据安全
- **密码加密**: bcrypt哈希存储
- **HTTPS支持**: 生产环境SSL/TLS加密
- **日志审计**: 完整的操作记录

## 📊 监控和运维

### 1. 健康检查
- **代理心跳**: 5秒间隔的心跳检测
- **连接状态**: 实时连接数和状态监控
- **性能指标**: 响应时间、吞吐量统计

### 2. 日志管理
- **分级日志**: INFO、WARN、ERROR、DEBUG
- **日志轮转**: 自动分割和归档
- **日志导出**: 支持CSV格式导出

### 3. 告警机制
- **离线检测**: 代理服务异常告警
- **流量异常**: 超出限制阈值告警
- **系统资源**: CPU、内存、磁盘监控

## 🛠️ 技术选型说明

### 后端技术
- **Go语言**: 高性能、并发处理能力强
- **Gin框架**: 轻量级、高性能的HTTP框架
- **GORM**: 功能丰富的ORM框架，支持多种数据库
- **MySQL**: 成熟稳定的关系型数据库

### 前端技术
- **Vue3**: 现代化的前端框架，组合式API
- **Element Plus**: 企业级UI组件库
- **Vite**: 快速的构建工具，开发体验好
- **Pinia**: 轻量级状态管理库

### 网络协议
- **SOCKS5**: 标准代理协议，兼容性好
- **HTTP/HTTPS**: RESTful API接口
- **WebSocket**: 实时数据推送（可选）

## 🔧 配置管理

### 配置文件结构
```yaml
server:
  port: "8012"           # API服务器端口
  host: "0.0.0.0"        # 监听地址
  mode: "debug"          # 运行模式

proxy:
  port: "1082"           # 代理服务端口
  host: "0.0.0.0"        # 监听地址
  timeout: 30            # 连接超时
  max_connections: 1000  # 最大连接数

database:
  driver: "mysql"        # 数据库类型
  host: "127.0.0.1"      # 数据库地址
  port: "3306"           # 数据库端口
```

## 📈 扩展性设计

### 1. 水平扩展
- **API服务**: 支持多实例部署，负载均衡
- **代理服务**: 支持多节点部署，客户端自动选择
- **数据库**: 支持主从复制、读写分离

### 2. 功能扩展
- **插件系统**: 支持自定义认证、过滤插件
- **API扩展**: RESTful接口易于扩展
- **协议支持**: 可扩展支持HTTP代理、Shadowsocks等

### 3. 监控扩展
- **Prometheus**: 指标收集和监控
- **Grafana**: 可视化仪表板
- **ELK Stack**: 日志分析和搜索

## 🚀 部署建议

### 1. 系统要求
- **操作系统**: Linux (推荐Ubuntu 20.04+)
- **内存**: 最小2GB，推荐4GB+
- **存储**: 最小10GB，推荐50GB+
- **网络**: 稳定的网络连接

### 2. 性能优化
- **连接池**: 数据库连接池配置
- **缓存策略**: Redis缓存热点数据
- **负载均衡**: Nginx反向代理和负载均衡
- **CDN加速**: 静态资源CDN分发

### 3. 安全加固
- **防火墙**: 只开放必要端口
- **SSL证书**: Let's Encrypt免费证书
- **定期更新**: 系统和依赖包更新
- **备份策略**: 数据库和配置文件备份

---

*本文档描述了SOCKS5代理服务器系统的完整架构设计，包括技术选型、部署方案、安全特性和扩展性考虑。如有疑问或需要详细说明，请参考相关代码实现或联系开发团队。*
