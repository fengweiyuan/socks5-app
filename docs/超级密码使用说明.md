# 超级密码功能说明

## 概述

超级密码是一个特殊的密码，配置在系统配置文件中。当用户使用超级密码进行认证时，即使该密码与数据库中存储的用户密码不同，也能通过认证。

## 功能特性

- **全局生效**: 超级密码在Web登录和SOCKS5代理认证中均有效
- **优先级**: 超级密码验证优先于普通密码验证
- **安全性**: 超级密码配置在服务器端，只有系统管理员可以访问
- **灵活性**: 可以通过修改配置文件随时更改超级密码

## 配置方法

### 1. 修改配置文件

编辑 `configs/config.yaml` 文件，在 `auth` 部分添加或修改 `super_password` 字段：

```yaml
auth:
  session_timeout: 3600
  max_login_attempts: 5
  super_password: "%VirWorkSocks!"  # 超级密码，可以绕过数据库密码验证
```

### 2. 默认配置

系统默认超级密码为：`%VirWorkSocks!`

如果配置文件中未设置超级密码，系统会自动使用此默认值。

## 使用场景

### 场景1: Web管理界面登录

当需要紧急访问管理界面，但忘记了用户密码时：

```bash
# 使用任意存在的用户名 + 超级密码登录
用户名: admin
密码: %VirWorkSocks!
```

### 场景2: SOCKS5代理连接

当需要为任意用户提供临时访问权限时：

```bash
# SOCKS5代理配置
代理地址: 127.0.0.1:1082
用户名: 任意存在的用户名
密码: %VirWorkSocks!
```

### 场景3: 紧急运维

在数据库故障或用户密码异常的情况下，管理员可以使用超级密码快速恢复服务访问。

## 认证流程

```
用户输入用户名和密码
    ↓
检查用户是否存在且状态为active
    ↓
输入的密码 == 超级密码？
    ├─ 是 → 认证通过 ✅
    └─ 否 → 验证数据库中的密码哈希
              ├─ 匹配 → 认证通过 ✅
              └─ 不匹配 → 认证失败 ❌
```

## 注意事项

### 安全建议

1. **修改默认密码**: 在生产环境中，务必修改默认超级密码
2. **复杂密码**: 使用包含特殊字符、数字和字母的复杂密码
3. **定期更换**: 建议定期更换超级密码
4. **访问控制**: 严格控制配置文件的访问权限
5. **审计日志**: 监控使用超级密码登录的记录

### 最佳实践

```yaml
# 推荐的超级密码格式
super_password: "!@#Complex$uper%Pa$$w0rd&*("

# 不推荐的超级密码
super_password: "123456"          # 太简单
super_password: "admin"           # 易猜测
super_password: ""                # 空密码（会禁用超级密码功能）
```

### 权限限制

- 超级密码只能用于**已存在**且**状态为active**的用户
- 如果用户不存在或已被禁用，即使使用超级密码也无法通过认证
- 这确保了超级密码不会被用于创建未授权的访问

## 测试验证

运行测试脚本验证超级密码功能：

```bash
# 测试超级密码功能
python3 scripts/test_super_password.py

# 或
./scripts/test_super_password.py
```

测试脚本会验证：
1. Web登录使用超级密码
2. Web登录使用错误密码被拒绝
3. SOCKS5代理使用超级密码
4. SOCKS5代理使用错误密码被拒绝

## 实现细节

### 配置结构体

```go
type AuthConfig struct {
    SessionTimeout   int    `mapstructure:"session_timeout"`
    MaxLoginAttempts int    `mapstructure:"max_login_attempts"`
    SuperPassword    string `mapstructure:"super_password"` // 超级密码
}
```

### 认证函数

```go
func AuthenticateUser(username, password string) (*database.User, error) {
    // ... 查询用户 ...
    
    // 检查是否使用超级密码
    if config.GlobalConfig.Auth.SuperPassword != "" && 
       password == config.GlobalConfig.Auth.SuperPassword {
        return &user, nil
    }
    
    // 验证普通密码
    if !CheckPassword(password, user.Password) {
        return nil, errors.New("密码错误")
    }
    
    return &user, nil
}
```

## 禁用超级密码

如果需要禁用超级密码功能，可以将其设置为空字符串：

```yaml
auth:
  session_timeout: 3600
  max_login_attempts: 5
  super_password: ""  # 禁用超级密码
```

或者直接从配置文件中删除该字段。

## 故障排除

### 问题1: 超级密码不生效

**可能原因**:
- 配置文件格式错误
- 服务未重启
- 用户不存在或已被禁用

**解决方法**:
1. 检查 `config.yaml` 语法是否正确
2. 重启服务：`./scripts/service.sh restart`
3. 确认用户存在且状态为active

### 问题2: 超级密码被意外暴露

**立即操作**:
1. 修改配置文件中的超级密码
2. 重启所有服务
3. 检查访问日志，确认是否有未授权访问
4. 考虑轮换受影响用户的密码

## 相关文件

- 配置文件: `configs/config.yaml`
- 配置加载: `internal/config/config.go`
- 认证逻辑: `internal/auth/auth.go`
- Web登录: `internal/api/auth.go`
- SOCKS5认证: `internal/proxy/socks5.go`
- 测试脚本: `scripts/test_super_password.py`

## 版本历史

- **v1.0** (2025-10-09): 初始实现
  - 添加超级密码配置
  - 在Web登录和SOCKS5代理中实现超级密码认证
  - 创建测试脚本

