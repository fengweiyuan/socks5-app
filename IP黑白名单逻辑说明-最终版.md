# IP黑白名单过滤逻辑说明（最终版）

## 核心逻辑

**白名单只用于赦免黑名单，不用于限制访问范围。**

## 过滤规则

```
1. 检查黑名单：
   - 如果在黑名单中：
     ✓ 如果也在白名单中 → 通过（白名单赦免）
     ✗ 如果不在白名单中 → 拒绝

2. 如果不在黑名单中 → 直接通过
```

**关键点**：只要不在黑名单中，就可以通过，无论是否在白名单中。

---

## 三种场景详解

### 场景 1：只定义了黑名单（没有白名单）

**规则：默认通过，只有匹配黑名单的才拒绝**

```
黑名单：192.168.10.0/24
白名单：空

测试结果：
- 192.168.10.100 → ❌ 拒绝（匹配黑名单）
- 192.168.10.200 → ❌ 拒绝（匹配黑名单）
- 192.168.1.100  → ✅ 通过（不在黑名单）
- 10.0.0.1       → ✅ 通过（不在黑名单）
- 任意其他IP     → ✅ 通过（不在黑名单）
```

**✅ 符合预期**：只有黑名单生效，其他所有IP默认允许通过。

---

### 场景 2：只定义了白名单（没有黑名单）

**规则：白名单不起作用，所有IP都可以通过**

```
黑名单：空
白名单：192.168.1.100, 192.168.1.101

测试结果：
- 192.168.1.100 → ✅ 通过（不在黑名单）
- 192.168.1.101 → ✅ 通过（不在黑名单）
- 192.168.1.102 → ✅ 通过（不在黑名单）
- 10.0.0.1      → ✅ 通过（不在黑名单）
- 任意其他IP     → ✅ 通过（不在黑名单）
```

**⚠️ 重要**：如果只配置白名单而不配置黑名单，白名单不会起到任何作用！

**建议**：如果要限制只允许特定IP访问，应该：
- 黑名单：添加一个覆盖所有IP的规则（如 `0.0.0.0/0`）
- 白名单：添加允许访问的IP

---

### 场景 3：同时定义了黑名单和白名单

**规则：白名单赦免黑名单中的IP**

#### 3.1 IP同时在黑名单和白名单中（白名单赦免）

```
黑名单：192.168.10.0/24
白名单：192.168.10.100

访问IP：192.168.10.100

处理流程：
1. 检查黑名单 → 192.168.10.100 匹配 192.168.10.0/24 → 在黑名单中
2. 检查白名单 → 192.168.10.100 在白名单中
3. 结果：✅ 通过（白名单赦免）

日志输出：
IP白名单赦免黑名单规则 - IP: 192.168.10.100, 黑名单规则: 192.168.10.0/24 (描述), 白名单: 192.168.10.100 (描述)
```

**✅ 白名单赦免生效**

---

#### 3.2 IP在黑名单中但不在白名单中

```
黑名单：192.168.10.0/24
白名单：192.168.10.100

访问IP：192.168.10.200

处理流程：
1. 检查黑名单 → 192.168.10.200 匹配 192.168.10.0/24 → 在黑名单中
2. 检查白名单 → 192.168.10.200 不在白名单中
3. 结果：❌ 拒绝

拒绝原因：匹配IP黑名单规则: 192.168.10.0/24 (描述)，且不在白名单中
```

**✅ 黑名单生效**

---

#### 3.3 IP不在黑名单（无论是否在白名单）

```
黑名单：192.168.10.0/24
白名单：192.168.1.100

访问IP：192.168.1.100（在白名单中）
处理流程：
1. 检查黑名单 → 192.168.1.100 不匹配 → 不在黑名单中
2. 结果：✅ 直接通过

访问IP：10.0.0.1（不在白名单中）
处理流程：
1. 检查黑名单 → 10.0.0.1 不匹配 → 不在黑名单中
2. 结果：✅ 直接通过
```

**✅ 不在黑名单就通过，白名单不影响**

---

## 逻辑流程图

```
           [开始检查IP]
                |
                ↓
        [检查黑名单]
                |
       ┌────────┴────────┐
       |                 |
   在黑名单中        不在黑名单中
       |                 |
       ↓                 ↓
  [检查白名单]        [✅ 通过]
       |
  ┌────┴────┐
  |         |
在白名单  不在白名单
  |         |
  ↓         ↓
[✅通过]  [❌拒绝]
(赦免)
```

---

## 完整真值表

| 场景 | 黑名单配置 | 白名单配置 | IP在黑名单 | IP在白名单 | 结果 | 说明 |
|------|------------|------------|------------|------------|------|------|
| 1 | 空 | 空 | - | - | ✅ 通过 | 无任何限制，全部放行 |
| 2 | 空 | 有 | - | 是 | ✅ 通过 | 不在黑名单，直接通过 |
| 3 | 空 | 有 | - | 否 | ✅ 通过 | 不在黑名单，直接通过 |
| 4 | 有 | 空 | 否 | - | ✅ 通过 | 不在黑名单，直接通过 |
| 5 | 有 | 空 | 是 | - | ❌ 拒绝 | 在黑名单，无白名单赦免 |
| 6 | 有 | 有 | 否 | 是 | ✅ 通过 | 不在黑名单，直接通过 |
| 7 | 有 | 有 | 否 | 否 | ✅ 通过 | **不在黑名单，直接通过** ⭐ |
| 8 | 有 | 有 | 是 | 是 | ✅ 通过 | **白名单赦免** ⭐ |
| 9 | 有 | 有 | 是 | 否 | ❌ 拒绝 | 在黑名单且不在白名单 |

**重点**：场景7和场景8是关键区别点。

---

## 典型应用场景

### 场景A：屏蔽恶意网段但保留特定服务器

```
需求：屏蔽整个 172.16.0.0/12 网段，但允许 172.16.10.100 访问

配置：
- 黑名单：172.16.0.0/12
- 白名单：172.16.10.100

结果：
- 172.16.10.100 → ✅ 通过（白名单赦免）
- 172.16.10.200 → ❌ 拒绝（在黑名单，不在白名单）
- 172.16.x.x    → ❌ 拒绝（在黑名单，不在白名单）
- 192.168.1.1   → ✅ 通过（不在黑名单）
- 10.0.0.1      → ✅ 通过（不在黑名单）
```

**✅ 完美匹配需求**

---

### 场景B：只允许特定IP访问（类似传统白名单）

```
需求：只允许 192.168.1.100 和 192.168.1.101 访问

错误配置（不会生效）：
- 黑名单：空
- 白名单：192.168.1.100, 192.168.1.101
结果：所有IP都能通过（白名单不起作用）❌

正确配置：
- 黑名单：0.0.0.0/0（屏蔽所有IP）
- 白名单：192.168.1.100, 192.168.1.101

结果：
- 192.168.1.100 → ✅ 通过（白名单赦免）
- 192.168.1.101 → ✅ 通过（白名单赦免）
- 192.168.1.102 → ❌ 拒绝（在黑名单，不在白名单）
- 10.0.0.1      → ❌ 拒绝（在黑名单，不在白名单）
- 任意其他IP    → ❌ 拒绝（在黑名单，不在白名单）
```

**⚠️ 关键技巧**：用 `0.0.0.0/0` 作为黑名单，可以实现传统白名单模式。

---

### 场景C：屏蔽多个网段但保留特定IP

```
需求：
- 屏蔽 192.168.0.0/16 和 10.0.0.0/8
- 但允许 192.168.1.100 和 10.0.0.50 访问

配置：
- 黑名单：192.168.0.0/16, 10.0.0.0/8
- 白名单：192.168.1.100, 10.0.0.50

结果：
- 192.168.1.100 → ✅ 通过（白名单赦免）
- 10.0.0.50     → ✅ 通过（白名单赦免）
- 192.168.x.x   → ❌ 拒绝（在黑名单，不在白名单）
- 10.x.x.x      → ❌ 拒绝（在黑名单，不在白名单）
- 172.16.1.1    → ✅ 通过（不在黑名单）
- 8.8.8.8       → ✅ 通过（不在黑名单）
```

**✅ 灵活控制**

---

## 核心特点

### ✅ 优点

1. **逻辑简单清晰**：
   - 黑名单 = 禁止列表
   - 白名单 = 赦免列表
   - 不在黑名单 = 自动通过

2. **灵活性高**：
   - 可以屏蔽大网段，然后用白名单放行特定IP
   - 通过 `0.0.0.0/0` 黑名单实现传统白名单模式

3. **性能好**：
   - 不在黑名单时直接返回，无需检查白名单
   - 大部分情况下只需要一次黑名单检查

### ⚠️ 注意事项

1. **白名单单独使用无效**：
   - 如果只配置白名单不配置黑名单，白名单不会起作用
   - 要实现"只允许白名单访问"，需要配置黑名单为 `0.0.0.0/0`

2. **赦免优先级最高**：
   - 在白名单中的IP，即使在黑名单中也会通过

3. **默认开放策略**：
   - 如果黑白名单都为空，默认允许所有IP通过
   - 这是一种开放策略，适合大部分场景

---

## 对比：新旧逻辑

### 旧逻辑（已废弃）
```
1. 先检查白名单：
   - 有白名单 → 不在白名单 → 拒绝
2. 再检查黑名单：
   - 在黑名单 → 拒绝

问题：
- 白名单既用于限制又用于赦免，逻辑复杂
- 如果只配白名单，会限制所有不在白名单的IP
```

### 新逻辑（当前）✅
```
1. 检查黑名单：
   - 在黑名单 → 检查白名单赦免
2. 不在黑名单 → 直接通过

优点：
- 职责单一：黑名单=禁止，白名单=赦免
- 逻辑简单：不在黑名单就通过
- 灵活性高：可以通过技巧实现各种模式
```

---

## 日志输出

### 白名单赦免时
```
IP白名单赦免黑名单规则 - IP: 192.168.10.100, 黑名单规则: 192.168.10.0/24 (测试网段), 白名单: 192.168.10.100 (管理员IP)
```

### 黑名单拒绝时
```
IP被过滤 - 用户: testuser, 目标: 192.168.10.200, 原因: 匹配IP黑名单规则: 192.168.10.0/24 (测试网段)，且不在白名单中
```

---

## 快速参考

| 需求 | 黑名单配置 | 白名单配置 | 效果 |
|------|------------|------------|------|
| 屏蔽某个网段 | 192.168.10.0/24 | 空 | 只屏蔽该网段 |
| 屏蔽网段但放行特定IP | 192.168.10.0/24 | 192.168.10.100 | 网段被屏蔽，但100可访问 |
| 只允许特定IP访问 | 0.0.0.0/0 | 192.168.1.100 | 只有100可访问 |
| 允许所有访问 | 空 | 空 | 全部允许 |
| 屏蔽多个网段 | 多条规则 | 空 | 屏蔽指定网段 |

---

## 代码位置

- 实现文件：`/internal/proxy/socks5.go`
- 函数名：`checkIPFilter(targetAddr string) (bool, string)`
- 行号：925-1001

---

## 更新时间

2025-10-22 最终版

