# IP黑白名单过滤逻辑说明

## 核心逻辑

新的过滤逻辑遵循"**白名单可以赦免黑名单**"的原则。

## 三种场景详解

### 场景 1：只定义了黑名单（没有白名单）

**规则：默认通过，只有匹配黑名单的才拒绝**

```
黑名单：192.168.10.0/24
白名单：空

处理流程：
1. 检查黑名单 → 192.168.10.100 匹配 → 在黑名单中
2. 检查是否有白名单 → 没有白名单
3. 结果：❌ 拒绝（黑名单直接生效）

测试结果：
- 192.168.10.100 → ❌ 拒绝（匹配黑名单）
- 192.168.1.100  → ✅ 通过（不在黑名单，无白名单限制）
- 10.0.0.1       → ✅ 通过（不在黑名单，无白名单限制）
```

**✅ 符合预期**：只有黑名单生效，其他所有IP默认允许通过。

---

### 场景 2：只定义了白名单（没有黑名单）

**规则：默认拒绝，只有匹配白名单的才通过**

```
黑名单：空
白名单：192.168.1.100, 192.168.1.101

处理流程：
1. 检查黑名单 → 192.168.1.102 不在黑名单
2. 检查白名单 → 有白名单规则
3. 检查是否在白名单 → 192.168.1.102 不在白名单
4. 结果：❌ 拒绝（不在白名单中）

测试结果：
- 192.168.1.100 → ✅ 通过（在白名单中）
- 192.168.1.101 → ✅ 通过（在白名单中）
- 192.168.1.102 → ❌ 拒绝（不在白名单中）
- 10.0.0.1      → ❌ 拒绝（不在白名单中）
```

**✅ 符合预期**：只有白名单中的IP可以通过，其他所有IP都被拒绝。

---

### 场景 3：同时定义了黑名单和白名单

**规则：先看黑名单，白名单可以"赦免"黑名单中的IP**

#### 3.1 IP同时在黑名单和白名单中（白名单赦免）

```
黑名单：192.168.10.0/24
白名单：192.168.10.100

访问IP：192.168.10.100

处理流程：
1. 检查黑名单 → 192.168.10.100 匹配 192.168.10.0/24 → 在黑名单中
2. 检查白名单 → 有白名单规则
3. 检查是否在白名单 → 192.168.10.100 在白名单中
4. 结果：✅ 通过（白名单赦免）

日志输出：
IP白名单赦免黑名单规则 - IP: 192.168.10.100, 黑名单规则: 192.168.10.0/24, 白名单: 192.168.10.100
```

**✅ 白名单优先**：即使在黑名单中，只要在白名单中就可以通过。

---

#### 3.2 IP在黑名单中但不在白名单中

```
黑名单：192.168.10.0/24
白名单：192.168.1.100

访问IP：192.168.10.200

处理流程：
1. 检查黑名单 → 192.168.10.200 匹配 192.168.10.0/24 → 在黑名单中
2. 检查白名单 → 有白名单规则
3. 检查是否在白名单 → 192.168.10.200 不在白名单中
4. 结果：❌ 拒绝（匹配黑名单且不在白名单中）

拒绝原因：匹配IP黑名单规则: 192.168.10.0/24，且不在白名单中
```

**✅ 黑名单生效**：在黑名单中且不在白名单中，被拒绝。

---

#### 3.3 IP不在黑名单但在白名单中

```
黑名单：192.168.10.0/24
白名单：192.168.1.100

访问IP：192.168.1.100

处理流程：
1. 检查黑名单 → 192.168.1.100 不匹配 → 不在黑名单中
2. 检查白名单 → 有白名单规则
3. 检查是否在白名单 → 192.168.1.100 在白名单中
4. 结果：✅ 通过（在白名单中）
```

**✅ 白名单生效**：不在黑名单且在白名单中，通过。

---

#### 3.4 IP既不在黑名单也不在白名单

```
黑名单：192.168.10.0/24
白名单：192.168.1.100

访问IP：10.0.0.1

处理流程：
1. 检查黑名单 → 10.0.0.1 不匹配 → 不在黑名单中
2. 检查白名单 → 有白名单规则
3. 检查是否在白名单 → 10.0.0.1 不在白名单中
4. 结果：❌ 拒绝（不在白名单中）

拒绝原因：不在IP白名单中
```

**✅ 白名单限制**：不在黑名单但也不在白名单中，被拒绝。

---

## 逻辑流程图

```
                    [开始检查IP]
                         |
                         ↓
        ┌──────────[检查黑名单]──────────┐
        |                               |
    在黑名单中                      不在黑名单中
        |                               |
        ↓                               ↓
   [检查白名单]                    [检查白名单]
        |                               |
  ┌─────┴─────┐                   ┌─────┴─────┐
  |           |                   |           |
有白名单    无白名单             有白名单    无白名单
  |           |                   |           |
  ↓           ↓                   ↓           ↓
[在白名单?] [拒绝]             [在白名单?] [通过]
  |                               |
┌─┴─┐                           ┌─┴─┐
|   |                           |   |
是  否                           是  否
|   |                           |   |
↓   ↓                           ↓   ↓
通过 拒绝                        通过 拒绝
(赦免)                                (白名单限制)
```

## 完整真值表

| 黑名单 | 白名单 | 在黑名单 | 在白名单 | 结果 | 说明 |
|--------|--------|----------|----------|------|------|
| 空 | 空 | - | - | ✅ 通过 | 无任何限制 |
| 有 | 空 | 否 | - | ✅ 通过 | 不在黑名单，无白名单限制 |
| 有 | 空 | 是 | - | ❌ 拒绝 | 在黑名单，无白名单赦免 |
| 空 | 有 | - | 是 | ✅ 通过 | 在白名单中 |
| 空 | 有 | - | 否 | ❌ 拒绝 | 不在白名单中 |
| 有 | 有 | 是 | 是 | ✅ 通过 | **白名单赦免** |
| 有 | 有 | 是 | 否 | ❌ 拒绝 | 在黑名单且不在白名单 |
| 有 | 有 | 否 | 是 | ✅ 通过 | 在白名单中 |
| 有 | 有 | 否 | 否 | ❌ 拒绝 | 不在白名单中 |

## 核心特点

### ✅ 优点

1. **灵活性高**：
   - 可以先屏蔽一个大网段（如整个办公网 192.168.0.0/16）
   - 然后用白名单放行特定IP（如管理员IP 192.168.1.100）

2. **安全性好**：
   - 白名单可以覆盖黑名单，提供"特赦"机制
   - 有白名单时，默认拒绝所有未明确允许的IP

3. **逻辑清晰**：
   - 先看是否被禁止（黑名单）
   - 再看是否有特权（白名单赦免）
   - 最后看是否在允许范围内（白名单限制）

### 📝 典型应用场景

#### 场景A：屏蔽恶意网段但保留特定服务器
```
黑名单：172.16.0.0/12 （屏蔽整个私网B段）
白名单：172.16.10.100 （允许特定服务器）

结果：
- 172.16.x.x 全部被屏蔽
- 除了 172.16.10.100 可以通过（白名单赦免）
```

#### 场景B：只允许办公网访问
```
黑名单：空
白名单：192.168.1.0/24

结果：
- 只有 192.168.1.0-255 可以通过
- 其他所有IP都被拒绝
```

#### 场景C：组合使用
```
黑名单：192.168.0.0/16, 10.0.0.0/8
白名单：192.168.1.100, 192.168.1.101

结果：
- 192.168.1.100, 192.168.1.101 可以通过（白名单赦免）
- 其他 192.168.x.x 和 10.x.x.x 都被拒绝
- 其他IP也都被拒绝（因为有白名单，默认拒绝）
```

## 代码位置

实现文件：`/internal/proxy/socks5.go`
函数名：`checkIPFilter(targetAddr string) (bool, string)`
行号：925-1016

## 测试建议

1. **测试只有黑名单**：
   - 添加黑名单规则 `192.168.10.0/24`
   - 测试 192.168.10.100 → 应该被拒绝
   - 测试 192.168.1.100 → 应该通过

2. **测试只有白名单**：
   - 添加白名单规则 `192.168.1.100`
   - 测试 192.168.1.100 → 应该通过
   - 测试 192.168.1.101 → 应该被拒绝

3. **测试白名单赦免**：
   - 添加黑名单规则 `192.168.10.0/24`
   - 添加白名单规则 `192.168.10.100`
   - 测试 192.168.10.100 → 应该通过（白名单赦免）
   - 测试 192.168.10.101 → 应该被拒绝
   - 查看日志应该看到"IP白名单赦免黑名单规则"信息

## 日志输出

### 白名单赦免时的日志
```
IP白名单赦免黑名单规则 - IP: 192.168.10.100, 黑名单规则: 192.168.10.0/24 (测试网段), 白名单: 192.168.10.100 (管理员IP)
```

### 拒绝时的日志
```
IP被过滤 - 用户: testuser, 目标: 192.168.10.200, 原因: 匹配IP黑名单规则: 192.168.10.0/24 (测试网段)，且不在白名单中
```

或

```
IP被过滤 - 用户: testuser, 目标: 10.0.0.1, 原因: 不在IP白名单中
```

